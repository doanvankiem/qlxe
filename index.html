<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Form Đăng Ký</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
<div class="container">
  <div class="center-align">
    <h4>Tạo đơn</h4>
  </div>

  <form action="" id="frm-create-order">
    <div class="row">
      <div class="col s12">
        <div class="input-field">
          <select id="loai-hang" required>
            <option value="" selected>Chọn loại hàng</option>
            <option value="Hàng Tổng Hợp">Hàng Tổng Hợp</option>
            <option value="Hàng Cảng">Hàng Cảng</option>
          </select>
          <label>Loại Hàng</label>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s12">
        <div class="input-field">
          <select id="ten-bai" required>
            <option value="" selected>Chọn tên bãi</option>
          </select>
          <label>Tên Bãi</label>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s12">
        <div class="input-field">
          <select id="ma-hang" required>
            <option value="" selected>Chọn mã hàng</option>
          </select>
          <label>Mã Hàng</label>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s12">
        <div class="input-field">
          <input id="cuoc-thu-bai" type="text" readonly>
          <label for="cuoc-thu-bai">Cước Thu Bãi</label>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s12">
        <div class="input-field">
          <input id="gia-mua" type="text" readonly>
          <label for="gia-mua">Giá Mua</label>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s12">
        <div class="input-field">
          <input id="tien-cuoc" type="text" readonly>
          <label for="tien-cuoc">Tiền Cước</label>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s12">
        <div class="input-field">
          <input id="so-chuyen" type="text" readonly>
          <label for="so-chuyen">Số Chuyến</label>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s12">
        <div class="input-field">
          <input id="tai-xe" type="text" readonly>
          <label for="tai-xe">Tài Xế</label>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s12">
        <div class="input-field">
          <input id="boi-duong" type="text" readonly>
          <label for="boi-duong">Bồi Dưỡng</label>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s12">
        <div class="input-field">
          <input id="dau-tieu-thu" type="text" readonly>
          <label for="dau-tieu-thu">Dầu Tiêu Thụ</label>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s12">
        <div class="input-field">
          <input id="tien-dau" type="text" readonly>
          <label for="tien-dau">Tiền Dầu</label>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s12">
        <div class="input-field">
          <input id="dia-diem-van-chuyen" type="text" readonly>
          <label for="dia-diem-van-chuyen">Địa Điểm V/C</label>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s12">
        <div class="input-field">
          <select id="thanh-toan">
            <option value="" selected>Trạng thái thanh toán</option>
            <option value="Đã thanh toán">Đã thanh toán</option>
            <option value="Chưa thanh toán">Chưa thanh toán</option>
          </select>
          <label>Thanh Toán</label>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s12">
        <div class="input-field">
          <textarea id="ghi-chu" class="materialize-textarea"></textarea>
          <label for="ghi-chu">Ghi Chú</label>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s12">
        <div class="input-field">
          <input id="thanh-tien" type="text" readonly>
          <label for="thanh-tien">Thành Tiền</label>
        </div>
      </div>
    </div>

    <div class="row">
    <div class="col s6">
      <button id="clear-btn" class="btn red lighten-1 waves-effect waves-light" type="button">Nhập lại
        <i class="material-icons right">clear</i>
      </button>
    </div>
    <div class="col s6 right-align">
      <button id="submit-btn" class="btn waves-effect waves-light" type="button">Lưu
        <i class="material-icons right">send</i>
      </button>
    </div>
  </div>
  </form>
</div>
<script>
  const spreadsheetId = '13RTGIJ4LrIKGe8YaOBJrisDqUDAiC3wAZUs-MEjqP8g';
  const apiKey = 'AIzaSyB6RdUNIvZUAo2u8EVgRcMlLNUZup4Lo3s';

  const data = [
    {
      tenBai: 'Bãi Thịnh',
      range: 'CAIDAT!$P$2:$Y$1001',
    },
    {
      tenBai: 'Anh Quỳnh',
      range: 'CAIDAT!$AL$2:$AT$1001',
    },
    {
      tenBai: 'Anh Linh',
      range: 'CAIDAT!$AV$2:$BD$1001',
    },
    {
      tenBai: 'Bãi Thắng',
      range: 'CAIDAT!$AA$2:$AJ$1001',
    },
    {
      tenBai: 'Bãi Tùng Bưởi',
      range: 'CAIDAT!$BF$2:$BO$1001',
    },
    {
      tenBai: 'Bãi Tuyến Tuyến',
      range: 'CAIDAT!$BQ$2:$BZ$1001',
    },
    {
      tenBai: 'Bãi Á Thành',
      range: 'CAIDAT!$CB$2:$CK$1001',
    },
    {
      tenBai: 'Bãi Tuyến Huê',
      range: 'CAIDAT!$CM$2:$CV$1001',
    },
    {
      tenBai: 'Bãi Phú Phong',
      range: 'CAIDAT!$CX$2:$DG$1001',
    },
    {
      tenBai: 'Bãi Hạnh Hoa',
      range: 'CAIDAT!$DI$2:$DR$1001',
    },
    {
      tenBai: 'Bãi Hùng',
      range: 'CAIDAT!$DT$2:$EC$1001',
    },
    {
      tenBai: 'Bãi Tròn',
      range: 'CAIDAT!$EE$2:$EN$1001',
    },
    {
      tenBai: 'Bãi Huế Nguyệt',
      range: 'CAIDAT!$EP$2:$EY$1001',
    },
    {
      tenBai: 'Bãi Nam',
      range: 'CAIDAT!$FA$2:$FJ$1001',
    },
    {
      tenBai: 'Bãi Bằng',
      range: 'CAIDAT!$FL$2:$FU$1001',
    },
    {
      tenBai: 'Bãi TDC',
      range: 'CAIDAT!$FW$2:$GF$1001',
    },
    {
      tenBai: 'Bãi An Lợi Phú',
      range: 'CAIDAT!$GH$2:$GQ$1001',
    },
    {
      tenBai: 'Bãi Khánh',
      range: 'CAIDAT!$GS$2:$HB$1001',
    },
    {
      tenBai: 'Bãi 1',
      range: 'CAIDAT!$HD$2:$HM$1001',
    },
    {
      tenBai: 'Bãi 2',
      range: 'CAIDAT!$HO$2:$HX$1001',
    },
    {
      tenBai: 'Bãi 3',
      range: 'CAIDAT!$HZ$2:$II$1001',
    },
    {
      tenBai: 'Bãi 4',
      range: 'CAIDAT!$IK$2:$IT$1001',
    },
    {
      tenBai: 'Bãi 5',
      range: 'CAIDAT!$IV$2:$JE$1001',
    },
    {
      tenBai: 'Bãi 6',
      range: 'CAIDAT!$JG$2:$JP$1001',
    },
  ];

  function parseCurrency(currencyString) {
    return parseFloat(currencyString.replace(/\./g, '').replace(' đ', ''));
  }

  function formatCurrency(value) {
    return value.toLocaleString('vi-VN') + ' đ'; // Định dạng theo kiểu Việt Nam
  }

  function getRange(tenBai) {
    return data.find(item => item.tenBai === tenBai).range ?? '';
  }

  function loadTenBai(loaiHang) {
    const range = loaiHang === 'Hàng Tổng Hợp' ? 'CAIDAT!$H$5:$H$1000' : 'CAIDAT!$H$3:$H$4';
    $.ajax({
      url: `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`,
      method: 'GET',
      success: function(response) {
        const rows = response.values;
        if (rows && rows.length > 0) {
          rows.forEach((row) => {
            $('#ten-bai').append(`<option value="${row}">${row}</option>`);
          });
        }
        $('select').formSelect(); // Reinitialize Materialize select
      },
      error: function(err) {
        console.error('Error fetching data:', err);
      }
    });
  }

  function loadMaHang() {
    const loaiHang = $('#loai-hang').val();
    const range = loaiHang === 'Hàng Tổng Hợp' ? 'CAIDAT!$B$11:$B$29' : 'CAIDAT!$B$3:$B$10';
    $.ajax({
      url: `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`,
      method: 'GET',
      success: function(response) {
        const rows = response.values;
        if (rows && rows.length > 0) {
          rows.forEach((row) => {
            $('#ma-hang').append(`<option value="${row}">${row}</option>`);
          });
        }
        $('select').formSelect(); // Reinitialize Materialize select
      },
      error: function(err) {
        console.error('Error fetching data:', err);
      }
    });
  }

  function loadData() {
    const range = getRange($('#ten-bai').val());
    $.ajax({
      url: `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`,
      method: 'GET',
      success: function(response) {
        const rows = response.values;
        if (rows && rows.length > 0) {
          rows.forEach((items, index) => {
            const selectedItem = items.find(item => item === $('#ma-hang').val());
            if (selectedItem) {
              $('#cuoc-thu-bai').val(rows[index][1]);
              $('#gia-mua').val(rows[index][2]);
              $('#tien-cuoc').val(rows[index][3]);
              $('#so-chuyen').val(rows[index][8]);
              $('#tai-xe').val(rows[index][4]);
              $('#boi-duong').val(rows[index][7]);
              $('#dau-tieu-thu').val(rows[index][5]);
              $('#tien-dau').val(rows[index][6]);
              $('#dia-diem-van-chuyen').val(rows[index][9]);
              const total = parseCurrency(rows[index][1]) - parseCurrency(rows[index][2]) - parseCurrency(rows[index][4]) - parseCurrency(rows[index][6]) - parseCurrency(rows[index][7]);
              $('#thanh-tien').val(formatCurrency(total));
              M.updateTextFields();
            }
          });
        }
      },
      error: function(err) {
        console.error('Error fetching data:', err);
      }
    });
  }

  function getOrderCode() {
    const date = new Date();

    const yy = date.getFullYear().toString().slice(-2); // Lấy 2 chữ số cuối của năm
    const MM = ('0' + (date.getMonth() + 1)).slice(-2); // Tháng bắt đầu từ 0, nên cộng thêm 1
    const dd = ('0' + date.getDate()).slice(-2);        // Ngày
    const hh = ('0' + date.getHours()).slice(-2);        // Giờ
    const ii = ('0' + date.getMinutes()).slice(-2);      // Phút

    return yy + MM + dd + hh + ii;
  }

  function initClient() {
    gapi.client.init({
      'apiKey': 'AIzaSyB6RdUNIvZUAo2u8EVgRcMlLNUZup4Lo3s',
      'clientId': '308244759435-mmoss8uvha5gqt3pml789fbmrq6th0vr.apps.googleusercontent.com',
      'scope': 'https://www.googleapis.com/auth/spreadsheets',
      'discoveryDocs': ['https://sheets.googleapis.com/$discovery/rest?version=v4']
    }).then(function () {
      console.log('GAPI client loaded for API');
    }, function (error) {
      console.error('Error loading GAPI client for API', error);
    });
  }

  function loadClient() {
    gapi.load('client:auth2', initClient);
  }

  function appendData(data) {
    const spreadsheetId = 'YOUR_SPREADSHEET_ID'; // Thay thế với ID của Google Sheets
    const range = 'NHATKY!A1'; // Thay đổi với tên sheet và vị trí ô bắt đầu

    const values = [
      [loaiHang, tenBai, maHang] // Dữ liệu cần thêm
    ];

    const body = {
      values: values
    };

    gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId: spreadsheetId,
      range: range,
      valueInputOption: 'RAW',
      resource: body
    }).then((response) => {
      const result = response.result;
      console.log(`${result.updates.updatedCells} cells appended.`);
      alert('Dữ liệu đã được thêm thành công!');
    }, (error) => {
      console.error('Error adding data to Google Sheets: ', error);
      alert('Đã xảy ra lỗi khi thêm dữ liệu.');
    });
  }

  $(document).ready(function () {
    loadClient();
    $('#clear-btn').click(function() {
      $('#frm-create-order')[0].reset();
    });

    $('#submit-btn').click(function() {
      const formData = {
        maDonHang: getOrderCode(),
        loaiHang: $('#loai-hang').val(),
        tenBai: $('#ten-bai').val(),
        maHang: $('#ma-hang').val(),
        cuocThuBai: $('#cuoc-thu-bai').val(),
        giaMua: $('#gia-mua').val(),
        tienCuoc: $('#tien-cuoc').val(),
        soChuyen: $('#so-chuyen').val(),
        taiXe: $('#tai-xe').val(),
        boiDuong: $('#boi-duong').val(),
        dauTieuThu: $('#dau-tieu-thu').val(),
        tienDau: $('#tien-dau').val(),
        diaDiemVanChuyen: $('#dia-diem-van-chuyen').val(),
        trangThaiThanhToan: $('#thanh-toan').val(),
        thanhToan: $('#thanh-toan').val(),
        ghiChu: $('#ghi-chu').val(),
        thanhTien: $('#thanh-tien').val()
      };
      /*$.ajax({
        url: 'https://script.google.com/macros/s/AKfycbyMtiz0sRs1yxqe6RX0m60rpbpJD2W-FQEa_wRo5iyoeUqIjmxu2BS0kLUU9toCES0iEQ/exec',  // URL của Apps Script Web App
        method: 'POST',
        contentType: 'application/json',
        dataType: 'json',
        data: JSON.stringify(formData),
        success: function(response) {
          console.log('Form đã được submit thành công:', response);
          alert('Dữ liệu đã gửi thành công!');
        },
        error: function(xhr, status, error) {
          console.error('Lỗi khi submit form:', status, error);
          alert('Có lỗi xảy ra!');
        }
      });*/
      fetch('https://script.google.com/macros/s/AKfycbyMtiz0sRs1yxqe6RX0m60rpbpJD2W-FQEa_wRo5iyoeUqIjmxu2BS0kLUU9toCES0iEQ/exec', {
        method: 'POST',
        body: JSON.stringify(formData),
        headers: {
          'Content-Type': 'application/json'
        },
        mode: 'cors',
        credentials: 'same-origin',
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            alert('Data submitted successfully!');
          } else {
            alert('There was an error submitting the data.');
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
    });

    $('select').formSelect();

    // Load Tên Bãi based on Loại Hàng
    $('#loai-hang').change(function () {
      const loaiHang = $(this).val();
      $('#ten-bai').html('<option value="" disabled selected>Chọn tên bãi</option>'); // Reset Tên Bãi
      $('#ma-hang').html('<option value="" disabled selected>Chọn mã hàng</option>'); // Reset Mã Hàng
      if (loaiHang !== '') {
        loadTenBai(loaiHang);
      }
    });

    // Load Mã Hàng based on Tên Bãi
    $('#ten-bai').change(function () {
      $('#ma-hang').html('<option value="" disabled selected>Chọn mã hàng</option>'); // Reset Mã Hàng
      loadMaHang();
      $('select').formSelect(); // Reinitialize Materialize select
    });

    // Load remaining fields based on Mã Hàng
    $('#ma-hang').change(function () {
      if ($('#ten-bai').val()) {
        loadData();
      }
    });
  });
</script>
</body>
</html>
