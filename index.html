<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Form Đăng Ký</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.10.7/dayjs.min.js"></script>
  <style>
    .fixed {
      position: fixed;
      bottom: 0;
      left: 0;
      background: #fff;
      right: 0;
      -webkit-box-shadow: 0 -1px 10px 0 rgba(0, 0, 0, 0.75);
      -moz-box-shadow: 0 -1px 10px 0 rgba(0, 0, 0, 0.75);
      box-shadow: 0 -1px 10px 0 rgba(0, 0, 0, 0.75);
      padding: 10px;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="text-center text-uppercase">
    <h4>Tạo đơn</h4>
  </div>

  <form action="" id="frm-create-order">
    <div class="form-group">
      <label for="loai-hang">Loại Hàng</label>
      <select class="form-control" id="loai-hang" required>
        <option value="">Chọn loại hàng</option>
        <option value="Hàng Tổng Hợp">Hàng Tổng Hợp</option>
        <option value="Hàng Cảng">Hàng Cảng</option>
      </select>
      <div class="invalid-feedback">Vui lòng chọn loại hàng.</div>
    </div>

    <div class="form-group">
      <label for="ten-bai">Tên Bãi</label>
      <select class="form-control" id="ten-bai" required disabled>
        <option value="">Chọn tên bãi</option>
      </select>
      <div class="invalid-feedback">Vui lòng chọn tên bãi.</div>
    </div>

    <div class="form-group">
      <label for="ma-hang">Mã Hàng</label>
      <select class="form-control" id="ma-hang" required disabled>
        <option value="">Chọn mã hàng</option>
      </select>
      <div class="invalid-feedback">Vui lòng chọn mã hàng</div>
    </div>

    <div class="form-group">
      <label for="cuoc-thu-bai">Cước Thu Bãi</label>
      <input type="text" class="form-control" id="cuoc-thu-bai" readonly>
    </div>

    <div class="form-group">
      <label for="gia-mua">Giá Mua</label>
      <input type="text" class="form-control" id="gia-mua" readonly>
    </div>

    <div class="form-group">
      <label for="tien-cuoc">Tiền Cước</label>
      <input type="text" class="form-control" id="tien-cuoc" readonly>
    </div>

    <div class="form-group">
      <label for="so-chuyen">Số Chuyến</label>
      <input type="text" class="form-control" id="so-chuyen" readonly>
    </div>

    <div class="form-group">
      <label for="tai-xe">Tài Xế</label>
      <input type="text" class="form-control" id="tai-xe" readonly>
    </div>

    <div class="form-group">
      <label for="boi-duong">Bồi Dưỡng</label>
      <input type="text" class="form-control" id="boi-duong" readonly>
    </div>

    <div class="form-group">
      <label for="dau-tieu-thu">Dầu Tiêu Thụ</label>
      <input type="text" class="form-control" id="dau-tieu-thu" readonly>
    </div>

    <div class="form-group">
      <label for="tien-dau">Tiền Dầu</label>
      <input type="text" class="form-control" id="tien-dau" readonly>
    </div>

    <div class="form-group">
      <label for="dia-diem-van-chuyen">Địa Điểm V/C</label>
      <input type="text" class="form-control" id="dia-diem-van-chuyen" readonly>
    </div>

    <div class="form-group">
      <label for="thanh-toan">Thanh Toán</label>
      <select id="thanh-toan" class="form-control" disabled>
        <option value="">Trạng thái thanh toán</option>
        <option value="Đã thanh toán">Đã thanh toán</option>
        <option value="Chưa thanh toán" selected>Chưa thanh toán</option>
      </select>
    </div>

    <div class="form-group">
      <label for="ghi-chu">Ghi Chú</label>
      <textarea id="ghi-chu" class="form-control" disabled></textarea>
    </div>

    <div class="form-group">
      <label for="thanh-tien">Thành Tiền</label>
      <input type="text" class="form-control" id="thanh-tien" readonly>
    </div>

    <div class="row fixed">
      <div class="col s6 text-right">
        <button id="clear-btn" class="btn btn-danger" type="button" disabled>Nhập lại</button>
        <button id="submit-btn" class="btn btn-success" type="button" disabled>Lưu</button>
      </div>
    </div>
  </form>
</div>
<script>
  const spreadsheetId = '13RTGIJ4LrIKGe8YaOBJrisDqUDAiC3wAZUs-MEjqP8g';
  const apiKey = 'AIzaSyB6RdUNIvZUAo2u8EVgRcMlLNUZup4Lo3s';

  const data = [
    {
      tenBai: 'Bãi Thịnh',
      range: 'CAIDAT!$P$2:$Y$1001',
    },
    {
      tenBai: 'Anh Quỳnh',
      range: 'CAIDAT!$AL$2:$AT$1001',
    },
    {
      tenBai: 'Anh Linh',
      range: 'CAIDAT!$AV$2:$BD$1001',
    },
    {
      tenBai: 'Bãi Thắng',
      range: 'CAIDAT!$AA$2:$AJ$1001',
    },
    {
      tenBai: 'Bãi Tùng Bưởi',
      range: 'CAIDAT!$BF$2:$BO$1001',
    },
    {
      tenBai: 'Bãi Tuyến Tuyến',
      range: 'CAIDAT!$BQ$2:$BZ$1001',
    },
    {
      tenBai: 'Bãi Á Thành',
      range: 'CAIDAT!$CB$2:$CK$1001',
    },
    {
      tenBai: 'Bãi Tuyến Huê',
      range: 'CAIDAT!$CM$2:$CV$1001',
    },
    {
      tenBai: 'Bãi Phú Phong',
      range: 'CAIDAT!$CX$2:$DG$1001',
    },
    {
      tenBai: 'Bãi Hạnh Hoa',
      range: 'CAIDAT!$DI$2:$DR$1001',
    },
    {
      tenBai: 'Bãi Hùng',
      range: 'CAIDAT!$DT$2:$EC$1001',
    },
    {
      tenBai: 'Bãi Tròn',
      range: 'CAIDAT!$EE$2:$EN$1001',
    },
    {
      tenBai: 'Bãi Huế Nguyệt',
      range: 'CAIDAT!$EP$2:$EY$1001',
    },
    {
      tenBai: 'Bãi Nam',
      range: 'CAIDAT!$FA$2:$FJ$1001',
    },
    {
      tenBai: 'Bãi Bằng',
      range: 'CAIDAT!$FL$2:$FU$1001',
    },
    {
      tenBai: 'Bãi TDC',
      range: 'CAIDAT!$FW$2:$GF$1001',
    },
    {
      tenBai: 'Bãi An Lợi Phú',
      range: 'CAIDAT!$GH$2:$GQ$1001',
    },
    {
      tenBai: 'Bãi Khánh',
      range: 'CAIDAT!$GS$2:$HB$1001',
    },
    {
      tenBai: 'Bãi 1',
      range: 'CAIDAT!$HD$2:$HM$1001',
    },
    {
      tenBai: 'Bãi 2',
      range: 'CAIDAT!$HO$2:$HX$1001',
    },
    {
      tenBai: 'Bãi 3',
      range: 'CAIDAT!$HZ$2:$II$1001',
    },
    {
      tenBai: 'Bãi 4',
      range: 'CAIDAT!$IK$2:$IT$1001',
    },
    {
      tenBai: 'Bãi 5',
      range: 'CAIDAT!$IV$2:$JE$1001',
    },
    {
      tenBai: 'Bãi 6',
      range: 'CAIDAT!$JG$2:$JP$1001',
    },
  ];

  function parseCurrency(currencyString) {
    return parseFloat(currencyString.replace(/\./g, '').replace(' đ', ''));
  }

  function formatCurrency(value) {
    return value.toLocaleString('vi-VN') + ' đ'; // Định dạng theo kiểu Việt Nam
  }

  function getRange(tenBai) {
    return data.find(item => item.tenBai === tenBai).range ?? '';
  }

  function loadTenBai(loaiHang) {
    const range = loaiHang === 'Hàng Tổng Hợp' ? 'CAIDAT!$H$5:$H$1000' : 'CAIDAT!$H$3:$H$4';
    $.ajax({
      url: `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`,
      method: 'GET',
      success: function(response) {
        const rows = response.values;
        if (rows && rows.length > 0) {
          rows.forEach((row) => {
            $('#ten-bai').append(`<option value="${row}">${row}</option>`);
          });
        }
        $('#ten-bai').prop('disabled', false);
        $('#ten-bai').removeClass('is-invalid');
      },
      error: function(err) {
        console.error('Error fetching data:', err);
      }
    });
  }

  function loadMaHang() {
    const loaiHang = $('#loai-hang').val();
    const range = loaiHang === 'Hàng Tổng Hợp' ? 'CAIDAT!$B$11:$B$29' : 'CAIDAT!$B$3:$B$10';
    $.ajax({
      url: `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`,
      method: 'GET',
      success: function(response) {
        const rows = response.values;
        if (rows && rows.length > 0) {
          rows.forEach((row) => {
            $('#ma-hang').append(`<option value="${row}">${row}</option>`);
          });
        }
        $('#ma-hang').prop('disabled', false);
        $('#ma-hang').removeClass('is-invalid');
      },
      error: function(err) {
        console.error('Error fetching data:', err);
      }
    });
  }

  function loadData() {
    const range = getRange($('#ten-bai').val());
    $.ajax({
      url: `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`,
      method: 'GET',
      success: function(response) {
        const rows = response.values;
        if (rows && rows.length > 0) {
          rows.forEach((items, index) => {
            const selectedItem = items.find(item => item.toLowerCase().trim() === $('#ma-hang').val().toLowerCase().trim());
            if (selectedItem) {
              $('#cuoc-thu-bai').val(rows[index][1]);
              $('#gia-mua').val(rows[index][2]);
              $('#tien-cuoc').val(rows[index][3]);
              $('#so-chuyen').val(rows[index][8]);
              $('#tai-xe').val(rows[index][4]);
              $('#boi-duong').val(rows[index][7]);
              $('#dau-tieu-thu').val(rows[index][5]);
              $('#tien-dau').val(rows[index][6]);
              $('#dia-diem-van-chuyen').val(rows[index][9]);
              const total = parseCurrency(rows[index][1]) - parseCurrency(rows[index][2]) - parseCurrency(rows[index][4]) - parseCurrency(rows[index][6]) - parseCurrency(rows[index][7]);
              $('#thanh-tien').val(formatCurrency(total));
            }
          });
        }
      },
      error: function(err) {
        console.error('Error fetching data:', err);
      }
    });
  }

  function getOrderCode() {
    const date = new Date();

    const yy = date.getFullYear().toString().slice(-2); // Lấy 2 chữ số cuối của năm
    const MM = ('0' + (date.getMonth() + 1)).slice(-2); // Tháng bắt đầu từ 0, nên cộng thêm 1
    const dd = ('0' + date.getDate()).slice(-2);        // Ngày
    const hh = ('0' + date.getHours()).slice(-2);        // Giờ
    const ii = ('0' + date.getMinutes()).slice(-2);      // Phút

    return yy + MM + dd + hh + ii;
  }
  let nextRowIndex = 0;
  async function getLastRow() {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/NHATKY!A:S`;
    const accessToken = localStorage.getItem('access_token');

    try {
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          "Authorization": "Bearer " + accessToken,
          "Content-Type": "application/json"
        }
      });

      if (!response.ok) {
        window.location.href = "login.html";
      }

      const data = await response.json();
      const values = data.values;

      if (values.length > 0) {
        nextRowIndex = values.length + 1;
      }

    } catch (error) {
      console.error('Error fetching data:', error);
      window.location.href = "login.html";
    }
  }

  async function sendDataToSheet(body) {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/NHATKY!A${nextRowIndex}:append?valueInputOption=RAW`;
    const accessToken = localStorage.getItem('access_token');

    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          "Authorization": "Bearer " + accessToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });

      if (!response.ok) {
        throw new Error('Network response was not ok');
      }

      const data = await response.json();
      console.log('Form đã được submit thành công:', data);
      alert('Dữ liệu đã gửi thành công!');
      await getLastRow(); // Make sure to await if getLastRow is async
    } catch (error) {
      console.error('Lỗi khi submit form:', error);
      alert('Có lỗi xảy ra!');
    }
  }

  async function submitData() {
    await getLastRow();
    const formData = {
      maDonHang: getOrderCode(),
      loaiHang: $('#loai-hang').val(),
      tenBai: $('#ten-bai').val(),
      maHang: $('#ma-hang').val(),
      cuocThuBai: $('#cuoc-thu-bai').val(),
      giaMua: $('#gia-mua').val(),
      tienCuoc: $('#tien-cuoc').val(),
      soChuyen: $('#so-chuyen').val(),
      taiXe: $('#tai-xe').val(),
      boiDuong: $('#boi-duong').val(),
      dauTieuThu: $('#dau-tieu-thu').val(),
      tienDau: $('#tien-dau').val(),
      diaDiemVanChuyen: $('#dia-diem-van-chuyen').val(),
      trangThaiThanhToan: $('#thanh-toan').val(),
      thanhToan: $('#thanh-toan').val(),
      ghiChu: $('#ghi-chu').val(),
      thanhTien: $('#thanh-tien').val()
    };
    const currentDay = dayjs().format('DD/MM/YYYY');
    const values = [
      [
        currentDay, formData.maDonHang,
        formData.tenBai, formData.loaiHang,
        formData.maHang, '',
        '', formData.tienCuoc,
        formData.cuocThuBai, formData.soChuyen,
        formData.taiXe, formData.boiDuong,
        formData.dauTieuThu, formData.tienDau,
        formData.thanhTien, formData.diaDiemVanChuyen,
        formData.trangThaiThanhToan, formData.ghiChu,
      ],
    ];

    var body = {
      values: values
    };
    if (nextRowIndex > 0) {
      await sendDataToSheet(body);
    }
    $('#frm-create-order')[0].reset();
  }

  $(document).ready(function () {
    $('#clear-btn').click(function() {
      $('#frm-create-order')[0].reset();
    });
    getLastRow();

    $('#submit-btn').click(function() {
      submitData();
    });

    // Load Tên Bãi based on Loại Hàng
    $('#loai-hang').change(function () {
      const loaiHang = $(this).val();
      $('#ten-bai, #ma-hang').prop('disabled', true);
      $('#ten-bai').html('<option value="" selected>Chọn tên bãi</option>'); // Reset Tên Bãi
      $('#ma-hang').html('<option value="" selected>Chọn mã hàng</option>'); // Reset Mã Hàng
      if (loaiHang !== '') {
        loadTenBai(loaiHang);
      }
    });

    // Load Mã Hàng based on Tên Bãi
    $('#ten-bai').change(function () {
      $('#ma-hang').html('<option value="" selected>Chọn mã hàng</option>'); // Reset Mã Hàng
      loadMaHang();
    });

    // Load remaining fields based on Mã Hàng
    $('#ma-hang').change(function () {
      if ($('#ten-bai').val()) {
        loadData();
      }
      $('#ghi-chu, #thanh-toan, #submit-btn, #clear-btn').prop('disabled', false);
    });
  });
</script>
</body>
</html>
